---
title: "Assess Models"
author: "Aaron Till and Andrew Bray"
output: html_document
---

```{r}
library(tidyverse)
library(caret)
library(glmnet)
library(Matrix)
library(e1071)
library(broom)
library(yardstick)
```


## Load diagnostic functions

```{r}
plot_coefs <- function(tidy_model) {
  tidy_model %>%
    ggplot(aes(fct_reorder(term, estimate), estimate, fill = estimate > 0)) +
    geom_col(alpha = 0.8, show.legend = FALSE) +
    coord_flip() +
    labs(x = NULL)
}

plot_timeseries <- function(model, future_data, historical_data) {
  predictions <- predict(object = model, 
                         newdata = future, 
                         type = "response")
  
  f_data <- future %>%
    add_column(prob = predictions) %>%
    group_by(year) %>%
    summarize(temp       = mean(mean_surf),
              kills      = sum(prob)) 
  
  f_early <- f_data %>%
    filter(year < 2075) %>%
    mutate(kills_smooth = loess(kills ~ year, .)$fitted)
  
  f_late <- f_data %>%
    filter(year > 2075) %>%
    mutate(kills_smooth = loess(kills ~ year, .)$fitted)
  
  hist_data <- historical_data %>% 
    filter(year < 2014) %>%
    group_by(year) %>%
    summarize(temp = mean(mean_surf),
              kills = sum(summerkill == 1)) %>%
    mutate(kills_smooth = loess(kills ~ year, .)$fitted)
  
  gap_data <- tibble(year = c(2014:2040, 2060:2080))
  
  full_data <- f_early %>%
    bind_rows(f_late, hist_data, gap_data)
  
  # Construct timeseries plot
  ggplot(full_data, aes(x = year)) +
    geom_rect(xmin = 2015, xmax = 2040, ymin = 0, ymax = 110, fill = "lightgray", alpha = .002) +
    geom_rect(xmin = 2060, xmax = 2080, ymin = 0, ymax = 110, fill = "gray", alpha = .002) +
    geom_line(aes(y = kills_smooth)) +
    ylab("Total Predicted Summerkills") +
    xlab(NULL) +
    theme_bw()
}
```

## Load and partition data

```{r}
setwd("data/prepared_for_modeling/")
training <- read_csv("training.csv",
                     col_types = list(wbic = col_character(),
                                      year = col_character(),
                                      month  = col_character(),
                                      season = col_character(),
                                      summerkill = col_character(),
                                      ice_duration = col_double())) %>%
  mutate(summerkill = as.factor(summerkill))

testing <- read_csv("testing.csv",
                    col_types = list(wbic = col_character(),
                                     year = col_character(),
                                     month  = col_character(),
                                     season = col_character(),
                                     ice_duration = col_double())) %>%
  mutate(summerkill = as.factor(summerkill))
```

## Load models

```{r}
setwd("../models") 
model_names <- list.files()
all_models <- model_names %>%
  map(., ~read_rds(.x))
all_models <- tibble(name  = str_sub(str_extract(model_names, "^.*\\."), 
                                     1, -2),
                     model = all_models)
```

## Metrics

Extract fitted values and append as new column.

```{r}
predict_route <- function(model, newdata) {
  if("train" %in% class(model)) {
    predict(model, newdata, type = "prob")$pos
  } else {predict(model, newdata, type = "response")}
}

all_models <- all_models %>%
  mutate(fit_test = map(model, predict_route, newdata = testing))
```

Calculate logloss and auc.

```{r}
# the following can be made more concise w map()
auc <- rep(NA, nrow(all_models))
logloss <- auc
for (i in 1:nrow(all_models)) {
  a <- tibble(fit_test = all_models$fit_test[[i]],
              truth    = testing$summerkill)
  auc[i] <- roc_auc(a, truth, fit_test)$.estimate
  logloss[i] <- mn_log_loss(a, truth, fit_test)$.estimate
}

all_models <- all_models %>%
  add_column(auc, logloss) %>%
  arrange(logloss, auc)
```

## Coefficients

Extract coefficients from each model.

```{r}
extract_coef <- function(model, name) {
  if ("train" %in% class(model)) {
    m <- model$finalModel %>%
      coef(model$bestTune$lambda)
    out <- tibble(term = row.names(m),
                  estimate = m[, 1]) %>%
      filter(term != "(Intercept)") %>%
      select(term, estimate)
  }
  if ("glmerMod" %in% class(model)) {
    out <- model %>%
      tidy() %>%
      filter(group == "fixed") %>%
      filter(term != "(Intercept)") %>%
      filter(p.value <= .3) %>%
      select(term, estimate)
  }
  if ("glm" %in% class(model)) {
    out <- model %>%
      tidy() %>%
      filter(term != "(Intercept)") %>%
      select(term, estimate)
  }
}

all_models <- all_models %>%
  mutate(coef = map2(model, name, extract_coef))
```

Plot coefficients.

```{r}
all_models %>%
  unnest(coef) %>%
  ggplot(aes(x = fct_reorder(term, estimate), 
             y = estimate, 
             fill = estimate > 0)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ name, ncol = 2) +
  coord_flip() +
  labs(x = NULL) +
  theme_bw()
```



