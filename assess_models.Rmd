---
title: "Assess Models"
author: "Aaron Till and Andrew Bray"
output: html_document
---

```{r}
library(tidyverse)
library(caret)
library(glmnet)
library(Matrix)
library(e1071)
library(broom)
```

## Load and partition data

```{r}
setwd("data")
historical_data <- read_csv("processed/historical_data.csv",
                            col_types = list(summerkill = col_character(),
                                             ice_duration = col_double())) %>%
  select(-cause.category.4)
```

Separate into same test/train partition as used in model fitting.

```{r}
set.seed(998)
in_training <- createDataPartition(historical_data$summerkill,
                                  p = .75, list = FALSE)
training <- historical_data %>%
  mutate(summerkill = fct_recode(summerkill,
                                 "neg" = "0",
                                 "pos" = "1")) %>%
  slice(in_training)
testing  <- historical_data %>%
  mutate(summerkill = fct_recode(summerkill,
                                 "neg" = "0",
                                 "pos" = "1")) %>%
  slice(-in_training)

pre_proc_values <- preProcess(training, method = c("center", "scale"))
training <- predict(pre_proc_values, training)
testing  <- predict(pre_proc_values, testing) %>%
  mutate(summerkill = factor(testing$summerkill, 
                             levels = c("pos", "neg"), 
                             ordered = TRUE))
```

## Load models

```{r}
lasso_f1_logloss             <- read_rds("models/lasso_f1_logloss.rds")
lasso_f1_logloss_downsampled <- read_rds("models/lasso_f1_logloss_downsampled.rds")
re_f1                        <- read_rds("models/re_f1.rds")
```

## Make predictions

```{r}
p_lasso_f1_logloss             <- predict(lasso_f1_logloss, testing, type = "prob")
p_lasso_f1_logloss_downsampled <- predict(lasso_f1_logloss_downsampled, testing, type = "prob")
```

```{r}
testing %>%
  select(summerkill) %>%
  bind_cols(p_lasso_f1_logloss) %>%
  mutate(predicted = as.factor(ifelse(pos > .5, "pos", "neg"))) %>%
  metrics(truth = summerkill, estimate = predicted)
  roc_auc(summerkill, pos)

testing %>%
  select(summerkill) %>%
  bind_cols(p_lasso_f1_logloss_downsampled) %>%
  roc_auc(summerkill, pos)


```



 

```{r}
ggplot(lasso_f1_logloss)
ggplot(lasso_f1_logloss_downsampled)

ggplot(varImp(lasso_f1_logloss))
ggplot(varImp(lasso_f1_logloss_downsampled))

p1 <- predict(lasso_f1_logloss, historical_data, type = "prob")
p2 <- predict(lasso_f1_logloss_downsampled, historical_data, type = "prob")

a <- historical_data %>%
  select(summerkill) %>%
  mutate(truth = summerkill) %>%
  add_column(estimate = p1$neg) %>%
  roc_curve()
```

