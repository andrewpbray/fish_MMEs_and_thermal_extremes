---
title: "Fit Models"
author: "Aaron Till and Andrew Bray"
output: html_document
---

```{r}
library(tidyverse)
library(caret)
library(glmnet)
library(Matrix)
library(e1071)
library(pROC)
library(PRROC) 
library(glmnetUtils)
```

## Prepare data

```{r}
setwd("data/processed/")
historical_data <- read_csv("historical_data.csv",
                            col_types = list(wbic = col_factor(NULL),
                                             month  = col_factor(NULL),
                                             season = col_factor(NULL)))
```

Additional processing to make `caret` happy and faster.

```{r}
# historical_data <- historical_data %>%
#   filter(summerkill == "neg") %>%
#   sample_frac(.0005) %>%
#   bind_rows(filter(historical_data, summerkill == "pos"))
```

```{r}
m2_var <- c("wbic", "variance_after_ice_30", "variance_after_ice_60",
            "stratified_period_count", "schmidt", "cumulative_above_10",
            "ice_duration", "summerkill", "population", "lon", "lat", "season",
            "synth_temp")
set.seed(998)
in_training <- createDataPartition(historical_data$summerkill,
                                  p = .75, list = FALSE)
training <- historical_data %>%
  slice(in_training) %>%
  select(m2_vars)

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(m2_vars)
```



## Model 1: Lasso Logistic

First we must create the training and testing partitions. We begin this naively,
taking an SRS approach instead of a moving-windows time-series approach.

```{r}
m1_vars <- c("lat", "lon", "schmidt", "variance_after_ice_30",
         "variance_after_ice_60", "cumulative_above_0",
         "cumulative_above_5",  "cumulative_above_10",
         "max_surf", "mean_bot", "max_bot", "mean_surf", 
         "max_surf_z", "mean_bot_z", "max_bot_z", "mean_surf_z", 
         "summerkill", "population")
set.seed(998)
in_training <- createDataPartition(historical_data$summerkill,
                                  p = .75, list = FALSE)
training <- historical_data %>%
  slice(in_training) %>%
  select(m1_vars)

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(m1_vars)
```

In order to compare coefficients, we center and scale the predictors.

```{r}
pre_proc_values <- preProcess(training, method = c("center", "scale"))
train_transformed <- predict(pre_proc_values, training)
test_transformed  <- predict(pre_proc_values, testing)
```


Next we fit LASSO models with many difference lambdas, utilizing a 5-fold CV
scheme, repeated once, on the training data.

```{r}
fitControl <- trainControl(method = "repeatedcv",
                           number = 5,
                           repeats = 5,
                           summaryFunction = mnLogLoss,
                           classProbs = TRUE)

library(doParallel)
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

par_grid <-  expand.grid(alpha = 1,
                        lambda = seq(9e-8, 3.5e-7, length.out = 6))


set.seed(825)
lasso_fit_1 <- train(summerkill ~ ., 
                     data = train_transformed, 
                     method = "glmnet", 
                     metric = "mnLogLoss",
                     tuneGrid = par_grid,
                     trControl = fitControl)
ggplot(lasso_fit_1)

stopCluster(cl)

write_rds(lasso_fit_1, "../models/log_loss_opt_5_repeats.rds")

lasso_fit_1b <- train(summerkill ~ ., data = training, 
                 method = "glmnet", 
                 trControl = fitControl)

stopCluster(cl)
write_rds(lasso_fit_1, "../lasso_fit_1.rds")
write_rds(lasso_fit_1b, "../lasso_fit_1b.rds")
```


## Model 2: Lasso logistic with season fixed effects

```{r}
m2_vars <- c(m1_vars, "season")

training <- historical_data %>%
  slice(in_training) %>%
  select(m2_vars)

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(m2_vars)
```

```{r}
pre_proc_values <- preProcess(training, method = c("center", "scale"))
train_transformed <- predict(pre_proc_values, training)
test_transformed  <- predict(pre_proc_values, testing)
```

```{r}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

set.seed(825)
lasso_fit_2 <- train(summerkill ~ ., data = training, 
                 method = "glmnet", 
                 trControl = fitControl)

stopCluster(cl)
write_rds(lasso_fit_2, "../lasso_fit_2.rds")
```


## Model 3: Lasso logistic with month fixed effects

```{r}
m3_vars <- c(m1_vars, "month")

training <- historical_data %>%
  slice(in_training) %>%
  select(m3_vars)

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(m3_vars)
```

```{r}
pre_proc_values <- preProcess(training, method = c("center", "scale"))
train_transformed <- predict(pre_proc_values, training)
test_transformed  <- predict(pre_proc_values, testing)
```

```{r}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

set.seed(825)
lasso_fit_3 <- train(summerkill ~ ., data = training, 
                 method = "glmnet", 
                 trControl = fitControl)

stopCluster(cl)
write_rds(lasso_fit_3, "../lasso_fit_3.rds")
```











```{r}
m1 <- cv.glmnet(summerkill ~ .,
                data = historical_data[in_training, c(m1_vars, "summerkill")],
                family = "binomial",
                parallel = TRUE, 
                type.measure = "auc",
                keep = TRUE
)

m2 <- cv.glmnet(summerkill ~ .,
                data = historical_data[in_training, c(m1_vars, "summerkill")],
                family = "binomial",
                parallel = TRUE, 
                type.measure = "auc",
                keep = TRUE
)
```

