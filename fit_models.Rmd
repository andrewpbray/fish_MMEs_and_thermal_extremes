---
title: "Fit Models"
author: "Aaron Till and Andrew Bray"
output: html_document
---

```{r}
library(tidyverse)
library(caret)
library(glmnet)
library(Matrix)
library(e1071)
```

## Prepare data

```{r}
setwd("data/processed/")
historical_data <- read_csv("historical_data.csv")
historical_data <- historical_data %>%
  mutate(summerkill = factor(ifelse(is.na(summerkill), 0, summerkill)))
future_data     <- read_csv("future_data.csv")
```

## Model 1: Lasso Logistic

First we must create the training and testing partitions. We begin this naively,
taking an SRS approach instead of a moving-windows time-series approach.

```{r}
set.seed(998)
in_training <- createDataPartition(historical_data$summerkill,
                                  p = .75, list = FALSE)
training <- historical_data %>%
  slice(in_training) %>%
  select(lat, lon, schmidt, variance_after_ice_30,
         variance_after_ice_60, cumulative_above_0,
         cumulative_above_5,  cumulative_above_10,
         max_surf, mean_bot, max_bot, mean_surf, 
         max_surf_z, mean_bot_z, max_bot_z, mean_surf_z, 
         summerkill, population)

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(lat, lon, schmidt, variance_after_ice_30,
         variance_after_ice_60, cumulative_above_0,
         cumulative_above_5,  cumulative_above_10,
         max_surf, mean_bot, max_bot, mean_surf, 
         max_surf_z, mean_bot_z, max_bot_z, mean_surf_z, 
         summerkill, population)
```

In order to compare coefficients, we center and scale the predictors.

```{r}
pre_proc_values <- preProcess(training, method = c("center", "scale"))
train_transformed <- predict(pre_proc_values, training)
test_transformed  <- predict(pre_proc_values, testing)
```


Next we fit LASSO models with many difference lambdas, utilizing a 5-fold CV
scheme, repeated once, on the training data.

```{r}
fitControl <- trainControl(method = "repeatedcv",
                           number = 5,
                           repeats = 1)

library(doParallel)
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

set.seed(825)
lasso_fit_1 <- train(summerkill ~ ., data = train_transformed, 
                 method = "glmnet", 
                 trControl = fitControl)

lasso_fit_1b <- train(summerkill ~ ., data = training, 
                 method = "glmnet", 
                 trControl = fitControl)

stopCluster(cl)
write_rds(lasso_fit_1, "../lasso_fit_1.rds")
write_rds(lasso_fit_1b, "../lasso_fit_1b.rds")
```


## Model 2: Lasso logistic with season fixed effects

```{r}
training <- historical_data %>%
  slice(in_training) %>%
  select(lat, lon, schmidt, variance_after_ice_30,
         variance_after_ice_60, cumulative_above_0,
         cumulative_above_5,  cumulative_above_10,
         max_surf, mean_bot, max_bot, mean_surf, 
         max_surf_z, mean_bot_z, max_bot_z, mean_surf_z, 
         summerkill, population, season) %>%
  mutate(season = as_factor(season))

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(lat, lon, schmidt, variance_after_ice_30,
         variance_after_ice_60, cumulative_above_0,
         cumulative_above_5,  cumulative_above_10,
         max_surf, mean_bot, max_bot, mean_surf, 
         max_surf_z, mean_bot_z, max_bot_z, mean_surf_z, 
         summerkill, population, season) %>%
  mutate(season = as_factor(season))
```

```{r}
pre_proc_values <- preProcess(training, method = c("center", "scale"))
train_transformed <- predict(pre_proc_values, training)
test_transformed  <- predict(pre_proc_values, testing)
```

```{r}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

set.seed(825)
lasso_fit_2 <- train(summerkill ~ ., data = training, 
                 method = "glmnet", 
                 trControl = fitControl)

stopCluster(cl)
write_rds(lasso_fit_2, "../lasso_fit_2.rds")
```


## Model 3: Lasso logistic with month fixed effects

```{r}
training <- historical_data %>%
  slice(in_training) %>%
  select(lat, lon, schmidt, variance_after_ice_30,
         variance_after_ice_60, cumulative_above_0,
         cumulative_above_5,  cumulative_above_10,
         max_surf, mean_bot, max_bot, mean_surf, 
         max_surf_z, mean_bot_z, max_bot_z, mean_surf_z, 
         summerkill, population, month) %>%
  mutate(month = as_factor(month))

testing  <- historical_data %>%
  slice(-in_training) %>%
  select(lat, lon, schmidt, variance_after_ice_30,
         variance_after_ice_60, cumulative_above_0,
         cumulative_above_5,  cumulative_above_10,
         max_surf, mean_bot, max_bot, mean_surf, 
         max_surf_z, mean_bot_z, max_bot_z, mean_surf_z, 
         summerkill, population, month) %>%
  mutate(month = as_factor(month))
```

```{r}
pre_proc_values <- preProcess(training, method = c("center", "scale"))
train_transformed <- predict(pre_proc_values, training)
test_transformed  <- predict(pre_proc_values, testing)
```

```{r}
cl <- makePSOCKcluster(6)
registerDoParallel(cl)

set.seed(825)
lasso_fit_3 <- train(summerkill ~ ., data = training, 
                 method = "glmnet", 
                 trControl = fitControl)

stopCluster(cl)
write_rds(lasso_fit_3, "../lasso_fit_3.rds")
```
